# 문서 플랫폼 아키텍처 (StoryBakery)

## 배경
조직 내 여러 레포가 문서를 운영하면서도, 시각적 경험과 정보 구조는 통일되고
프로젝트별 커스텀은 크게 허용되는 구조가 필요합니다.

reference 문서는 생성 문서로 운영하며, Moonwave 도구는 사용하지 않습니다.
Luau 문서의 주석/태그/링크 규칙은 Moonwave 호환 스펙을 기준으로 합니다.
Luau 프로젝트는 luau-docgen 기반 추출기로 JSON을 생성해 reference를 구성합니다.

## 목표
- 조직 공통 테마/프리셋으로 문서 경험을 통일한다.
- Luau 프로젝트는 luau-docgen으로 reference JSON을 생성한다.
- Luau는 Moonwave 호환 주석/태그/링크 패턴을 유지한다.
- 비-Luau 프로젝트는 언어별 표준 추출 도구로 reference를 구성할 수 있으며, 수기 문서/커스텀 페이지를 조합해 운영한다.
- docs(수기)/reference(자동)/custom을 조합해 운영할 수 있어야 한다.
- 대규모 레포에서도 증분 빌드/캐시로 빠르게 동작한다.

## 비목표
- 모든 프로젝트를 단일 문서 사이트로 강제 통합하지 않는다.
- 특정 배포 환경에 종속된 설계를 강요하지 않는다.

## 기본 개념
- 기본 전략은 공통 preset/theme 패키지를 설치해 문서 경험을 통일한다.
- 프로젝트 레포는 문서 콘텐츠와 최소한의 설정만 소유한다.
- 문서 소스는 docs(수기)/reference/custom을 필요에 따라 조합한다.
- 기본 섹션은 docs(수기)와 reference를 분리한다.
- 공통 테마로 조직 식별 요소(브랜딩, 네비게이션, 푸터)를 유지한다.
- 템플릿 레포는 부트스트랩 용도로만 제한적으로 사용한다.
- 문서 사이트 루트는 `website/`를 표준으로 한다.

## 구성 요소 (표준)
- `@storybakery/docs-preset`
  - `@docusaurus/theme-classic` + `@storybakery/docs-theme`를 포함한다.
  - docs/pages 플러그인을 기본으로 로드한다.
  - reference 플러그인을 포함해 reference 섹션을 구성한다.
  - i18n 정책을 강제하는 옵션을 제공한다.
- `@storybakery/docs-theme`: 공통 디자인 토큰, 컴포넌트, 애니메이션
- `@storybakery/create-docs`: `website/` 템플릿과 의존성을 설치하는 CLI
- `@storybakery/luau-docgen`: Luau 공식 분석기 기반 추출기
- `@storybakery/docusaurus-plugin-reference`: Luau JSON → MDX 변환/로드
- JSON 스키마 v1: 추출기와 렌더러 간 계약

## 레포/폴더 레이아웃(표준)
```
website/
  docs/             # 사람이 작성하는 문서
    reference/      # 생성된 MD/MDX 문서 (언어별 하위 폴더)
  .generated/       # 생성 산출물 (gitignore)
  src/
    pages/          # 커스텀 페이지 (Docusaurus 전용)
  static/
    assets/         # 공통 정적 자산
src/                # 실제 제품 코드
```

## 적용 절차 (요약)
1. 프로젝트 레포에 문서 사이트 디렉터리(표준: `website/`)를 만든다.
2. 공통 preset 패키지를 설치한다.
3. `docusaurus.config.ts`에 문서 모드와 경로를 지정한다.
4. luau-docgen으로 JSON을 생성한 뒤 reference 문서를 구성한다.
5. Docusaurus 빌드를 수행하고 배포한다.

## 원클릭 설치 (CLI)
`@storybakery/create-docs`는 `website/` 템플릿과 의존성을 한 번에 설치한다.

```
npm create @storybakery/docs
```

기본 경로는 `website/`이며, 다른 경로가 필요하면 인자를 전달한다.

```
npm create @storybakery/docs -- docs-site
```

## 공통 프리셋 패키지 사용 (기본)
공통 프리셋은 표준 플러그인/테마 구성을 포함한다.

```
npm install --save @storybakery/docs-preset
```

```ts
// docusaurus.config.ts
export default {
  presets: [
    [
      '@storybakery/docs-preset',
      {
        docs: {
          path: './docs',
        },
        i18n: {
          defaultLocale: "en",
          locales: ["en", "ko"],
        },
        theme: {
          customCss: './src/css/custom.css',
        },
      },
    ],
  ],
};
```

## 공통 테마 패키지 사용 (예외)
프리셋 없이 테마만 단독으로 쓸 때는 아래처럼 추가한다.

```
npm install --save @storybakery/docs-theme
```

```ts
// docusaurus.config.ts
export default {
  themes: ['@storybakery/docs-theme'],
};
```

## 레포별 커스텀 레벨
공통 preset/theme를 기본값으로 사용하되, 레벨을 나눠 확장한다.

- Level 0: preset 옵션만 수정 (프로젝트 메타/링크/로고)
- Level 1: 공통 MDX 컴포넌트 사용
- Level 2: `website/src/pages`, `website/src/css/custom.css`, 로컬 플러그인, `clientModules`
- Level 3: `website/src/theme/*` swizzle (승인 필요)

### 주의
- `clientModules`에 넣는 코드는 SSR-safe여야 한다.
- DOM 접근 코드는 컴포넌트의 `useEffect`로 감싼다.
- swizzle은 업그레이드 리스크가 크므로 최소화한다.

## src/pages에 대한 기준
- `website/src/pages`는 Docusaurus 사이트의 라우팅을 위한 디렉터리다.
- 제품 코드가 이미 `src/`를 사용한다면 `website/` 구조를 유지한다.

## 사이드바 기준
- 기본: 단일 docs 인스턴스 + 수동 사이드바.
- docs(수기)와 reference는 최상위 섹션에서 분리한다.
- 수기 문서는 기본 docs 인스턴스로 `sidebars.ts`를 관리한다.
- 섞어서 배치해야 한다면 `sidebars.ts`를 수동으로 구성한다.
- 버저닝 수명주기가 다를 때만 docs 멀티 인스턴스를 사용한다.
- `manual`은 사이드바 ID 이름이며 `docs/manual` 폴더 분리를 의미하지 않는다.

```ts
// website/sidebars.ts
export default {
  manual: [{type: 'doc', id: 'index'}],
  reference: [{type: 'autogenerated', dirName: 'reference'}],
};
```

## Reference 문서 운영 (표준)
- reference 문서는 언어별 추출기가 생성한 JSON을 기준으로 만든다. Luau는 luau-docgen을 기본 제공한다.
- 표준 산출물 경로는 `website/.generated/reference/<lang>.json`이며, Luau는 `website/.generated/reference/luau.json`을 사용한다.
- 렌더링은 JSON → MDX 생성 또는 JSON 직접 로드 중 하나를 사용한다.
- Docusaurus는 `docs/reference/`(언어별 하위 디렉터리 포함)의 문서를 reference 섹션으로 제공한다.
- 산출물은 `website/.generated/`에 보관하고 Git 추적하지 않는다.

## Reference 산출물 소유권/정리 규칙
- Source of Truth(SoT): reference의 원천 데이터는 언어별 추출기가 생성한 JSON이다. Luau 표준 경로는 `website/.generated/reference/luau.json`이다.
- 생성 전용 디렉터리 예약: `website/docs/reference/`는 reference 생성 산출물을 위한 생성 전용 디렉터리로 예약한다(언어별 하위 디렉터리 포함).
- `website/docs/reference/` 및 `website/.generated/`는 생성 산출물이므로 Git에서 추적하지 않는다.
- 고아 파일 정리: 생성 과정은 반드시 정리(clean)를 수행한다.
- 권장: 생성 결과 목록(manifest)을 기준으로 생성 대상이 아닌 파일을 제거한다.
- 권장: 생성기는 JSON 입력 해시/버전 정보를 진단 로그 또는 메타 파일로 남긴다.

## 링크/슬러그/진단 규칙
### 링크(Short link) 해석
- Moonwave 호환 short link 규칙(`[ClassName]`, `[ClassName:method]`, `[ClassName.member]`)은 그대로 지원한다.
- 동일 표기에서 후보가 여러 개로 매칭될 수 있으므로, 해석은 결정적(deterministic)이어야 한다.
- 우선순위(권장): 1) 같은 모듈(또는 같은 파일/페이지 스코프) 2) 같은 레포 3) 다중 후보 시 안정적 타이브레이커(예: `moduleId`, `qualifiedName` 정렬 순).
- 다중 후보/미해결 링크는 진단 항목으로 수집한다.

### 슬러그/문서 ID 안정성
- reference 문서의 슬러그(또는 문서 ID)는 동일 입력에 대해 항상 동일하게 생성되어야 한다.
- 파일명/경로 정규화 규칙(대소문자, 공백, 특수문자 처리)은 조직 표준으로 고정한다.
- 리네임/이동으로 인한 링크 단절은 리다이렉트/alias 정책으로 다룬다(TBD).

### 진단(diagnostics) 정책
- 진단은 최소한 `unbound` 주석, 다중 후보 링크, 미해결 링크, 태그 파싱 오류, 타입 문자열 검증 실패를 포함한다.
- 기본 정책은 경고(warn)로 보고하되, CI/릴리즈 빌드에서는 옵션으로 오류(error) 승격이 가능해야 한다.

## 데이터/빌드 흐름 (표준)
```
프로젝트 문서 소스
  - 언어별 docgen(JSON) -> website/.generated/reference/<lang>.json (Luau는 luau-docgen)
  - JSON -> MDX 생성(선택) -> website/docs/reference/<lang>
  - 수동 문서 -> website/docs
  - 커스텀 페이지 -> website/src/pages
            |
            v
     Docusaurus 빌드
            |
            v
        정적 사이트
```

## Luau 문서 주석/태그/링크 규칙 (Moonwave 호환)
### Doc comment 블록
- `---` 연속 라인
- `--[=[ ... ]=]` 블록 주석 (단일 `=`)

### 블록 내부 규칙
- `@`로 시작하는 라인은 태그로 처리한다.
- `.`로 시작하는 라인은 interface field(dot-syntax)로 처리한다.
- 그 외 라인은 description으로 처리하고 Markdown을 허용한다.

### Doc comment 타입 태그
- 각 doc comment는 아래 타입 태그 중 정확히 하나를 포함해야 한다.
  - `@class <name>`
  - `@prop <name> <type>`
  - `@type <name> <type>`
  - `@interface <name>`
  - `@function <name>` 또는 `@method <name>`
- `@field <name> <type> -- [description]`은 `@interface` 내부 필드 선언으로 처리한다.

### 소속 규칙
- `@class`가 아닌 doc comment는 기본적으로 `@within <class>`가 필요하다.

### Short link
- `[ClassName]`, `[ClassName:method]`, `[ClassName.member]` 형태를 지원한다.

### 태그 목록
- 소속: `@within`
- function: `@yields`, `@param <name> [type] -- [description]`, `@return <type> -- [description]`, `@error <type> -- [description]`
- usage: `@tag <name>`, `@unreleased`, `@since <version>`, `@deprecated <version> -- [description]`
- realm: `@server`, `@client`, `@plugin`
- visibility: `@private`, `@ignore`
- property: `@readonly`
- class: `@__index <name>`
- external: `@external <name> <url>`

### 호환 제약/진단
- `@param`은 실제 파라미터와 1:1로 대응해야 한다.
- `@return`을 하나라도 쓰면 모든 반환값을 `@return`으로 명시한다.
- `@readonly`는 `@prop`에서만 유효하다.
- 타입 문자열은 Luau 타입 파서로 검증한다.

## Moonwave+ 확장 규칙 (권장)
- `@within`은 코드 패턴에서 자동 추론을 시도한다.
  - `function A:method(...)` -> within=`A`, kind=`method`
  - `function A.method(...)` 또는 `A.method = function(...)` -> within=`A`, kind=`function`
  - `A.prop = ...` -> within=`A`, kind=`property`
- 추론이 모호하면 `@within`을 요구하고 진단을 남긴다.
- `@prop/@method/@function`은 코드에 선언이 없는 가상 멤버 문서화에만 사용한다.
- `@param/@return/@error`는 들여쓰기 continuation을 허용해 멀티라인 설명을 지원한다.
- 반복/공통 문구를 줄이기 위해 다음 확장 태그를 지원할 수 있다.
  - `@inheritDoc <QualifiedName>`: 대상 문서를 상속/병합한다.
  - `@include <fragmentId>` 또는 `@snippet <path> [region]`: 문서/코드 조각을 삽입한다.
  - `@alias <name>`: 링크/검색 별칭을 추가한다.
- short link는 disambiguation 접두어를 지원할 수 있다. 예: `class@Foo`, `type@Foo`, `method@Foo:bar`

## luau-docgen 상세
### 입력 스캔/모듈 그래프
- 입력: `src/**/*.luau`, `src/**/*.lua`, 선택적 `types/**/*.d.luau`
- 모듈 ID: 파일 경로 기반 안정 ID를 기본으로 하고, `docs.config.json`으로 매핑 가능
- 증분 빌드: 파일 해시 + 의존 그래프로 재생성 범위를 최소화

### 타입체킹/심볼 해석
- `.luaurc` 병합 규칙을 그대로 적용한다.
- 파일 상단의 `--!strict|nonstrict|nocheck` 모드를 반영한다.
- 결과로 모듈 공개 심볼, 함수/테이블 멤버 타입, 타입 별칭을 수집한다.

### Doc comment 파싱(표준 스펙)
- 주석 블록: `---` 연속 라인, `--[=[ ... ]=]` 블록 주석
- 태그 문법은 Moonwave 호환 규칙을 따른다.
- 태그 타입 문자열은 Luau 타입 파서로 검증한다.

### 주석 ↔ AST 바인딩 규칙
- 기본: 주석 블록 바로 아래 첫 선언 노드에 바인딩한다.
- 지원 패턴: 함수 선언, `local X = {}`, `X.foo = function`, `function X:foo` 등.
- 애매한 경우: 태그 기반 심볼명 매칭으로 보정한다.
- 실패: `unbound`로 수집하고 경고/오류 정책에 따라 처리한다.

### 출력/진단
- JSON 스키마 v1에 맞춰 출력한다.
- 경고/오류는 파일/라인 기준으로 리포팅한다.

## JSON 스키마 v1(요약)
- 최상위: `schemaVersion`, `generatorVersion`, `luauVersion`, `modules`
- 모듈:
  - `id`, `path`, `sourceHash`, `symbols`
- 심볼:
  - `kind`: `class|function|property|type|interface|field|module`
  - `name`, `qualifiedName`, `location`(file/line/col)
  - `docs`: `summary`, `descriptionMarkdown`, `tags`, `examples`
  - `types`: `display`, `structured`
  - `visibility`: `public|private|ignored`
- 링크:
  - short link 해석 결과를 별도 `links`에 기록할 수 있다.

## 표시/정책
- 타입 표시는 명시 타입을 우선한다.
- 명시 타입이 없으면 추론 타입을 표시하되 과도하게 복잡하면 요약한다.
- `@private/@ignore`는 `visibility`에 반영하고 출력 여부를 제어한다.
- 이벤트 분류는 `@tag event` 또는 타입명 `Signal` 기준으로 처리한다.
- 시그니처 표시는 `block` 또는 `inline`을 지원한다.
- 요약 표시는 `top|section|both|none` 중 하나로 제어한다.
- 소스 링크는 repo URL, branch, basePath, stripPrefix로 구성한다.

## 다언어 Reference 확장 (커뮤니티 표준 입력)
- 입력은 언어별 커뮤니티 표준 주석/추출 도구를 우선한다.
- 출력은 JSON 스키마 v1로 매핑하거나 MDX 생성 파이프라인으로 합류한다.
- 언어별 reference는 `<lang>` 식별자로 경로를 분리해 병렬 운영할 수 있다.
- 프로젝트는 언어별 추출기/어댑터 추가를 전제로 구성한다.
- Luau는 Moonwave 호환 규칙을 기본 제공한다.
- 비-Luau는 Moonwave 태그를 강제하지 않는다.
- 대표 입력 예시:
  - TypeScript/JavaScript: TSDoc 또는 JSDoc, TypeDoc JSON
  - C/C++: Doxygen XML
  - Python: PEP 257 docstring, Sphinx autodoc
  - Java/Kotlin: Javadoc 또는 KDoc, Dokka
  - .NET (C#): XML documentation comments
  - Rust: rustdoc JSON (experimental)
  - Swift: DocC symbol graph
  - HTTP API: OpenAPI

## 다국어(i18n) 정책
언어는 Docusaurus i18n 규칙을 그대로 따른다. 언어를 `docs/ko`처럼 섞지 않는다.

### 기본 구조
```
website/
  docs/
    index.md
    guides/
    reference/
  i18n/
    ko/
      docusaurus-plugin-content-docs/
        current/
          index.md
          guides/
          reference/
      docusaurus-plugin-content-pages/
```

### 번역 범위
- docs(수기): 번역 대상. `i18n/<locale>/docusaurus-plugin-content-docs/current/`에 번역본을 둔다.
- reference(생성): 기본적으로 번역하지 않고, 모든 로케일에 원문을 복제해 구조를 맞춘다.
- custom pages: MDX는 `docusaurus-plugin-content-pages`로 번역, React는 번역 JSON으로 관리한다.

### 파이프라인 표준
1) reference 문서 준비
2) reference를 각 로케일의 `i18n/<locale>/.../current/reference/`로 복제
3) Docusaurus 빌드

### 운영 규칙
- `docusaurus write-translations -- --locale <code>`로 번역 골격을 만든다.
- 번역과 원문 구조는 동일하게 유지한다.

### 프리셋 i18n 강제 옵션
`@storybakery/docs-preset`에서 i18n 정책을 강제하려면 아래 옵션을 사용한다.

- `i18n.locales`: 허용 로케일 목록
- `i18n.defaultLocale`: 기본 로케일

정책과 다른 `siteConfig.i18n` 설정이 들어오면 빌드가 실패한다.

## 다크 모드
시스템 다크 모드를 기본으로 따르려면 `themeConfig.colorMode`를 설정한다.

```ts
// docusaurus.config.ts
export default {
  themeConfig: {
    colorMode: {
      defaultMode: "light",
      respectPrefersColorScheme: true,
    },
  },
};
```

## 커스텀 문서 모드
- Docusaurus의 `pages`와 커스텀 컴포넌트를 활용한다.
- 공통 테마와 애니메이션 유틸을 유지하면서 레이아웃만 교체한다.

## 업데이트 전략
- 공통 테마/프리셋은 버전으로 배포하고 프로젝트는 버전을 pin 한다.
- 공통 패키지는 Docusaurus 지원 범위를 명시한다.
- 브레이킹 변경은 마이그레이션 가이드를 동반한다.
- 템플릿 레포는 부트스트랩/예시 용도로만 최소 유지한다.

## 업데이트 방법 (프로젝트 레포)
```
npm install --save @storybakery/docs-preset@latest
```

또는:

```
npm update @storybakery/docs-preset
```

## 추적하지 않는 경로
- `website/build/`
- `website/.docusaurus/`
- `website/.generated/`
- `website/node_modules/`
