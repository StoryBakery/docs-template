# 사용법

## 목적
이 템플릿은 StoryBakery 조직 전체에서 문서의 톤, 구조, 그리고 시각적 경험을 통일하면서도
프로젝트별로 높은 커스텀성을 유지하는 것을 목표로 합니다.

## 기본 개념
- 기본 전략은 공통 preset/theme 패키지를 설치해 문서 경험을 통일한다.
- 프로젝트 레포는 문서 콘텐츠와 최소한의 설정만 소유한다.
- 문서 소스는 docs(수기)/reference/custom을 필요에 따라 조합한다.
- 기본 섹션은 docs(수기)와 reference를 분리한다.
- 공통 테마로 조직 식별 요소(브랜딩, 네비게이션, 푸터)를 유지한다.
- 템플릿 레포는 부트스트랩 용도로만 제한적으로 사용한다.

## 적용 절차 (요약)
1. 프로젝트 레포에 문서 사이트 디렉터리(표준: `website/`)를 만든다.
2. 공통 preset 패키지를 설치한다.
3. `docusaurus.config.ts`에 문서 모드와 경로를 지정한다.
4. (Moonwave 사용 시) Moonwave 출력물을 Docusaurus가 읽는 경로로 동기화한다.
5. Docusaurus 빌드를 수행하고 배포한다.

## 원클릭 설치 (CLI)
`@storybakery/create-docs`는 `website/` 템플릿과 의존성을 한 번에 설치합니다.

```
npm create @storybakery/docs
```

기본 경로는 `website/`이며, 다른 경로가 필요하면 인자를 전달합니다.

```
npm create @storybakery/docs -- docs-site
```

## 공통 프리셋 패키지 사용 (기본)
공통 프리셋은 표준 플러그인/테마 구성을 포함합니다.

```
npm install --save @storybakery/docs-preset
```

```ts
// docusaurus.config.ts
export default {
  presets: [
    [
      '@storybakery/docs-preset',
      {
        docs: {
          path: './docs',
        },
        i18n: {
          defaultLocale: "en",
          locales: ["en", "ko"],
        },
        i18nReference: {
          locales: ["ko"],
        },
        theme: {
          customCss: './src/css/custom.css',
        },
      },
    ],
  ],
};
```

## 공통 테마 패키지 사용 (예외)
프리셋 없이 테마만 단독으로 쓸 때는 아래처럼 추가합니다.

```
npm install --save @storybakery/docs-theme
```

```ts
// docusaurus.config.ts
export default {
  themes: ['@storybakery/docs-theme'],
};
```

## 레포별 커스텀 레벨
공통 preset/theme를 기본값으로 사용하되, 레벨을 나눠 확장합니다.

- Level 0: preset 옵션만 수정 (프로젝트 메타/링크/로고)
- Level 1: 공통 MDX 컴포넌트 사용
- Level 2: `website/src/pages`, `website/src/css/custom.css`, 로컬 플러그인, `clientModules`
- Level 3: `website/src/theme/*` swizzle (승인 필요)

### 주의
- `clientModules`에 넣는 코드는 SSR-safe여야 한다.
- DOM 접근 코드는 컴포넌트의 `useEffect`로 감싼다.
- swizzle은 업그레이드 리스크가 크므로 최소화한다.

### 예시
```ts
// docusaurus.config.ts
export default {
  presets: [
    [
      '@storybakery/docs-preset',
      {
        docs: {
          path: './docs',
        },
      },
    ],
  ],
  themeConfig: {
    navbar: {
      items: [{label: 'Status', to: '/status'}],
    },
  },
  plugins: ['./src/plugins/internal-metadata'],
  clientModules: ['./src/client/analytics.ts'],
};
```

## 권장 레이아웃
프로젝트 레포에서는 아래 레이아웃을 사용합니다.

```
website/
  docs/             # 사람이 작성하는 문서
    reference/      # 생성된 MD/MDX 문서
  .generated/
    moonwave/       # Moonwave JSON 산출물 (gitignore)
  src/
    pages/          # 커스텀 페이지 (Docusaurus 전용)
  static/
    assets/         # 공통 정적 자산
src/                # 실제 제품 코드
```

## src/pages에 대한 기준
- `website/src/pages`는 Docusaurus 사이트의 라우팅을 위한 디렉터리다.
- 제품 코드가 이미 `src/`를 사용한다면 `website/` 구조를 유지한다.

## Moonwave 연동 포인트
- Moonwave 출력물은 "생성물"로 간주하고 소스와 분리한다.
- Moonwave 출력물은 JSON 산출물로 고정한다.
- 표준 경로는 `website/.generated/moonwave/docs.json`이다.
- JSON을 MDX로 변환해 `website/docs/reference/`에 출력한다.
- Docusaurus는 변환된 MDX를 읽어 reference 섹션을 제공한다.
- 변환 브리지는 `@storybakery/docs-preset`에 포함하는 것을 기본으로 한다.
- 빌드 파이프라인에서 "Moonwave 출력 -> JSON to MDX -> Docusaurus 빌드" 순서를 유지한다.
- 산출물 디렉터리는 Git 추적하지 않는다.
- 로컬 개발 시에는 Moonwave 추출을 감시하는 스크립트를 함께 실행해 변경을 즉시 반영한다.
- 기본 스크립트는 Moonwave 릴리즈에서 extractor 바이너리를 자동으로 내려받는다.
- 별도 extractor를 쓰려면 `MOONWAVE_EXTRACTOR_CMD` 또는 `MOONWAVE_EXTRACTOR_PATH`를 설정한다.
- `MOONWAVE_EXTRACTOR_CMD`는 `{out}`에 JSON을 직접 기록해야 한다.
- `Signal` 타입의 프로퍼티는 기본적으로 events 섹션으로 분류한다.
- 소스 링크가 필요하면 `moonwave.source` 옵션을 사용한다.
- Moonwave 항목에 `tags`가 있을 때만 함수/이벤트 배지로 표시된다.
- JSON 추출 단계는 `moonwave-extractor` 실행을 기준으로 한다.

### Moonwave 옵션 예시
```ts
// docusaurus.config.ts
export default {
  organizationName: "storybakery",
  projectName: "docs-template",
  presets: [
    [
      "@storybakery/docs-preset",
      {
        moonwave: {
          source: true,
          classifySignalsAsEvents: true,
          summaryMode: "top",
          signatureStyle: "block",
          labels: {
            summary: "Summary",
            referenceType: "Engine Class",
            properties: "Properties",
          },
        },
      },
    ],
  ],
};
```

`moonwave.source`는 아래 형태를 지원한다.
- `true`: `organizationName` + `projectName`으로 GitHub 링크 자동 구성
- 문자열: `https://github.com/org/repo` 형식의 repo URL
- 객체: `{ repoUrl, branch, basePath, baseUrl, stripPrefix }` 형태로 수동 구성

`summaryMode`는 아래 값 중 하나다.
- `top`: 상단 Summary 섹션만 표시 (기본)
- `section`: 각 섹션 내부 요약만 표시
- `both`: 상단 + 섹션 요약 모두 표시
- `none`: 요약 섹션을 숨김

`signatureStyle`는 아래 값 중 하나다.
- `block`: 여러 줄 시그니처 (기본)
- `inline`: 한 줄 시그니처

## 사이드바 기준
- 기본: 단일 docs 인스턴스 + 수동 사이드바.
- docs(수기)와 reference는 최상위 섹션에서 분리한다.
- 수기 문서는 기본 docs 인스턴스로 `sidebars.ts`를 관리한다.
- 섞어서 배치해야 한다면 `sidebars.ts`를 수동으로 구성한다.
- 버저닝 수명주기가 다를 때만 docs 멀티 인스턴스를 사용한다.

```ts
// website/sidebars.ts
export default {
  manual: [{type: 'doc', id: 'index'}],
  reference: [{type: 'autogenerated', dirName: 'reference'}],
};
```

## 다국어(i18n) 정책
언어는 Docusaurus i18n 규칙을 그대로 따른다. 언어를 `docs/ko`처럼 섞지 않는다.

### 기본 구조
```
website/
  docs/
    index.md
    guides/
    reference/
  i18n/
    ko/
      docusaurus-plugin-content-docs/
        current/
          index.md
          guides/
          reference/
      docusaurus-plugin-content-pages/
```

### 번역 범위
- docs(수기): 번역 대상. `i18n/<locale>/docusaurus-plugin-content-docs/current/`에 번역본을 둔다.
- reference(생성): 기본적으로 번역하지 않고, 모든 로케일에 원문을 복제해 구조를 맞춘다.
- custom pages: MDX는 `docusaurus-plugin-content-pages`로 번역, React는 번역 JSON으로 관리한다.

### 파이프라인 표준
1) Moonwave JSON 추출
2) JSON -> MDX 변환 ( `website/docs/reference/` )
3) reference를 각 로케일의 `i18n/<locale>/.../current/reference/`로 복제
4) Docusaurus 빌드

### 운영 규칙
- `docusaurus write-translations -- --locale <code>`로 번역 골격을 만든다.
- 번역과 원문 구조는 동일하게 유지한다.

`reference` 복제는 Moonwave 브리지에서 자동으로 수행한다. 비활성화하려면
`moonwave.i18nReference: false`를 사용한다.

복제 대상 로케일을 제한하려면 다음처럼 지정한다.

```ts
moonwave: {
  i18nReference: {
    locales: ["ko", "ja"],
  },
}
```

지정하지 않으면 `siteConfig.i18n.locales`에서 기본 로케일을 제외한 값이 사용된다.

### 프리셋 i18n 강제 옵션
`@storybakery/docs-preset`에서 i18n 정책을 강제하려면 아래 옵션을 사용한다.

- `i18n.locales`: 허용 로케일 목록
- `i18n.defaultLocale`: 기본 로케일
- `i18nReference`: reference 복제 여부/대상 로케일

정책과 다른 `siteConfig.i18n` 설정이 들어오면 빌드가 실패한다.

## 다크 모드
시스템 다크 모드를 기본으로 따르려면 `themeConfig.colorMode`를 설정한다.

```ts
// docusaurus.config.ts
export default {
  themeConfig: {
    colorMode: {
      defaultMode: "light",
      respectPrefersColorScheme: true,
    },
  },
};
```

## 커스텀 문서 모드
- Docusaurus의 `pages`와 커스텀 컴포넌트를 활용한다.
- 공통 테마와 애니메이션 유틸을 유지하면서 레이아웃만 교체한다.

## 업데이트 전략
- 공통 테마/프리셋은 버전으로 배포하고 프로젝트는 버전을 pin 한다.
- 공통 패키지는 Docusaurus 지원 범위를 명시한다.
- 브레이킹 변경은 마이그레이션 가이드를 동반한다.
- 템플릿 레포는 부트스트랩/예시 용도로만 최소 유지한다.

## 업데이트 방법 (프로젝트 레포)
패키지는 최신 버전으로 갱신한다.

```
npm install --save @storybakery/docs-preset@latest
```

또는:

```
npm update @storybakery/docs-preset
```

## 추적하지 않는 경로
문서 사이트에서는 아래 경로를 Git 추적하지 않는다.

- `website/build/`
- `website/.docusaurus/`
- `website/.generated/`
- `website/node_modules/`
